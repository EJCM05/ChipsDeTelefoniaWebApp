{% extends 'pages/layouts/index.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid w-75 mt-4 min-vh-100">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Crear SIMCard para el lote: {{ lote.nombre_lote }}</h2>
    </div>
    <form method="post">
        {% csrf_token %}
        
        {{ form|crispy }}
        
        <button type="button" class="btn btn-outline-secondary w-100 mt-2" id="scan-button">
            Escanear Código de Barras
        </button>
        
        <div id="barcode-scanner-container" class="mt-3" style="display: none;">
            <video id="barcode-scanner-video" class="w-100 border rounded" style="max-height: 400px;"></video>
            <p class="mt-2 text-center text-muted">Apunta la cámara al código de barras.</p>
        </div>

        <button type="submit" class="btn btn-primary mt-3 w-100">Guardar</button>
        <a href="{% url 'dashboard:dashboard_home' %}" class="btn btn-secondary mt-3 w-100">Cancelar</a>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Obtiene los elementos del DOM.
    const scanButton = document.getElementById('scan-button');
    const inputField = document.getElementById('id_codigo'); // Este es el campo que quieres llenar
    const video = document.getElementById('barcode-scanner-video');
    const container = document.getElementById('barcode-scanner-container');
    
    // Asegúrate de que los elementos existen antes de continuar.
    if (scanButton && inputField && video && container) {
        const codeReader = new ZXing.BrowserMultiFormatReader();
        let isScanning = false;

        scanButton.addEventListener('click', () => {
            if (isScanning) {
                // Si el escáner está activo, lo detenemos.
                codeReader.reset();
                container.style.display = 'none';
                scanButton.textContent = 'Escanear Código de Barras';
                isScanning = false;
            } else {
                // Si está inactivo, lo iniciamos.
                isScanning = true;
                scanButton.textContent = 'Detener Escáner';
                container.style.display = 'block';

                // Inicia el escaneo.
                codeReader.decodeFromVideoDevice(null, 'barcode-scanner-video', (result, err) => {
                    if (result) {
                        console.log(`Código detectado: ${result.text}`);
                        // 2. Aquí es donde se llena el campo de texto.
                        inputField.value = result.text;
                        
                        // Detiene el escáner después de llenar el campo.
                        codeReader.reset();
                        container.style.display = 'none';
                        scanButton.textContent = 'Escanear Código de Barras';
                        isScanning = false;
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.error('Error al escanear:', err);
                        alert('Error al escanear: ' + err);
                    }
                });
            }
        });
        
        // Buena práctica: Detener el escáner si el usuario sale de la página.
        window.addEventListener('beforeunload', () => {
            if (isScanning) {
                codeReader.reset();
            }
        });
    } else {
        console.error('No se encontraron todos los elementos necesarios en el DOM. Revisa los IDs.');
    }
});
</script>
{% endblock %}
